root@38ff7a4514c0:/app# bash /tests/run-tests.sh; tmux wait -S done
Hit:1 http://deb.debian.org/debian trixie InRelease
Hit:2 http://deb.debian.org/debian trixie-updates InRelease
Hit:3 http://deb.debian.org/debian-security trixie-security InRelease
Reading package lists... Done
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following additional packages will be installed:
  bash-completion krb5-locales libbrotli1 libcom-err2 libcurl4t64 libgnutls30t64 libgssapi-krb5-2 libidn2-0 libk5crypto3 libkeyutils1 libkrb5-3
  libkrb5support0 libldap-common libldap2 libnghttp2-14 libnghttp3-9 libp11-kit0 libpsl5t64 librtmp1 libsasl2-2 libsasl2-modules libsasl2-modules-db
  libssh2-1t64 libtasn1-6 libunistring5 publicsuffix
Suggested packages:
  gnutls-bin krb5-doc krb5-user libsasl2-modules-gssapi-mit | libsasl2-modules-gssapi-heimdal libsasl2-modules-ldap libsasl2-modules-otp libsasl2-modules-sql
The following NEW packages will be installed:
  bash-completion curl krb5-locales libbrotli1 libcom-err2 libcurl4t64 libgnutls30t64 libgssapi-krb5-2 libidn2-0 libk5crypto3 libkeyutils1 libkrb5-3
  libkrb5support0 libldap-common libldap2 libnghttp2-14 libnghttp3-9 libp11-kit0 libpsl5t64 librtmp1 libsasl2-2 libsasl2-modules libsasl2-modules-db
  libssh2-1t64 libtasn1-6 libunistring5 publicsuffix
0 upgraded, 27 newly installed, 0 to remove and 0 not upgraded.
Need to get 5457 kB of archives.
After this operation, 19.5 MB of additional disk space will be used.
Get:1 http://deb.debian.org/debian trixie/main arm64 bash-completion all 1:2.16.0-7 [319 kB]
Get:2 http://deb.debian.org/debian trixie/main arm64 krb5-locales all 1.21.3-5 [101 kB]
Get:3 http://deb.debian.org/debian trixie/main arm64 libbrotli1 arm64 1.1.0-2+b7 [308 kB]
Get:4 http://deb.debian.org/debian trixie/main arm64 libkrb5support0 arm64 1.21.3-5 [32.4 kB]
Get:5 http://deb.debian.org/debian trixie/main arm64 libcom-err2 arm64 1.47.2-3+b3 [24.9 kB]
Get:6 http://deb.debian.org/debian trixie/main arm64 libk5crypto3 arm64 1.21.3-5 [81.2 kB]
Get:7 http://deb.debian.org/debian trixie/main arm64 libkeyutils1 arm64 1.6.3-6 [9716 B]
Get:8 http://deb.debian.org/debian trixie/main arm64 libkrb5-3 arm64 1.21.3-5 [308 kB]
Get:9 http://deb.debian.org/debian trixie/main arm64 libgssapi-krb5-2 arm64 1.21.3-5 [127 kB]
Get:10 http://deb.debian.org/debian trixie/main arm64 libunistring5 arm64 1.3-2 [453 kB]
Get:11 http://deb.debian.org/debian trixie/main arm64 libidn2-0 arm64 2.3.8-2 [107 kB]
Get:12 http://deb.debian.org/debian trixie/main arm64 libsasl2-modules-db arm64 2.1.28+dfsg1-9 [20.1 kB]
Get:13 http://deb.debian.org/debian trixie/main arm64 libsasl2-2 arm64 2.1.28+dfsg1-9 [55.6 kB]
Get:14 http://deb.debian.org/debian trixie/main arm64 libldap2 arm64 2.6.10+dfsg-1 [179 kB]
Get:15 http://deb.debian.org/debian trixie/main arm64 libnghttp2-14 arm64 1.64.0-1.1 [71.4 kB]
Get:16 http://deb.debian.org/debian trixie/main arm64 libnghttp3-9 arm64 1.8.0-1 [63.2 kB]
Get:17 http://deb.debian.org/debian trixie/main arm64 libpsl5t64 arm64 0.21.2-1.1+b1 [57.1 kB]
Get:18 http://deb.debian.org/debian trixie/main arm64 libp11-kit0 arm64 0.25.5-3 [409 kB]
Get:19 http://deb.debian.org/debian trixie/main arm64 libtasn1-6 arm64 4.20.0-2 [47.3 kB]
Get:20 http://deb.debian.org/debian trixie/main arm64 libgnutls30t64 arm64 3.8.9-3 [1375 kB]
Get:21 http://deb.debian.org/debian trixie/main arm64 librtmp1 arm64 2.4+20151223.gitfa8646d.1-2+b5 [56.8 kB]
Get:22 http://deb.debian.org/debian trixie/main arm64 libssh2-1t64 arm64 1.11.1-1 [235 kB]
Get:23 http://deb.debian.org/debian trixie/main arm64 libcurl4t64 arm64 8.14.1-2 [359 kB]
Get:24 http://deb.debian.org/debian trixie/main arm64 curl arm64 8.14.1-2 [262 kB]
Get:25 http://deb.debian.org/debian trixie/main arm64 libldap-common all 2.6.10+dfsg-1 [35.1 kB]
Get:26 http://deb.debian.org/debian trixie/main arm64 libsasl2-modules arm64 2.1.28+dfsg1-9 [62.9 kB]
Get:27 http://deb.debian.org/debian trixie/main arm64 publicsuffix all 20250328.1952-0.1 [296 kB]
Fetched 5457 kB in 0s (36.9 MB/s)
debconf: unable to initialize frontend: Dialog
debconf: (No usable dialog-like program is installed, so the dialog based frontend cannot be used. at /usr/share/perl5/Debconf/FrontEnd/Dialog.pm line 79, <STDI
N> line 27.)
debconf: falling back to frontend: Readline
debconf: unable to initialize frontend: Readline
debconf: (Can't locate Term/ReadLine.pm in @INC (you may need to install the Term::ReadLine module) (@INC entries checked: /etc/perl /usr/local/lib/aarch64-linu
x-gnu/perl/5.40.1 /usr/local/share/perl/5.40.1 /usr/lib/aarch64-linux-gnu/perl5/5.40 /usr/share/perl5 /usr/lib/aarch64-linux-gnu/perl-base /usr/lib/aarch64-linu
x-gnu/perl/5.40 /usr/share/perl/5.40 /usr/local/lib/site_perl) at /usr/share/perl5/Debconf/FrontEnd/Readline.pm line 8, <STDIN> line 27.)
debconf: falling back to frontend: Teletype
Selecting previously unselected package bash-completion.
(Reading database ... 7817 files and directories currently installed.)
Preparing to unpack .../00-bash-completion_1%3a2.16.0-7_all.deb ...
Unpacking bash-completion (1:2.16.0-7) ...
Selecting previously unselected package krb5-locales.
Preparing to unpack .../01-krb5-locales_1.21.3-5_all.deb ...
Unpacking krb5-locales (1.21.3-5) ...
Selecting previously unselected package libbrotli1:arm64.
Preparing to unpack .../02-libbrotli1_1.1.0-2+b7_arm64.deb ...
Unpacking libbrotli1:arm64 (1.1.0-2+b7) ...
Selecting previously unselected package libkrb5support0:arm64.
Preparing to unpack .../03-libkrb5support0_1.21.3-5_arm64.deb ...
Unpacking libkrb5support0:arm64 (1.21.3-5) ...
Selecting previously unselected package libcom-err2:arm64.
Preparing to unpack .../04-libcom-err2_1.47.2-3+b3_arm64.deb ...
Unpacking libcom-err2:arm64 (1.47.2-3+b3) ...
Selecting previously unselected package libk5crypto3:arm64.
Preparing to unpack .../05-libk5crypto3_1.21.3-5_arm64.deb ...
Unpacking libk5crypto3:arm64 (1.21.3-5) ...
Selecting previously unselected package libkeyutils1:arm64.
Preparing to unpack .../06-libkeyutils1_1.6.3-6_arm64.deb ...
Unpacking libkeyutils1:arm64 (1.6.3-6) ...
Selecting previously unselected package libkrb5-3:arm64.
Preparing to unpack .../07-libkrb5-3_1.21.3-5_arm64.deb ...
Unpacking libkrb5-3:arm64 (1.21.3-5) ...
Selecting previously unselected package libgssapi-krb5-2:arm64.
Preparing to unpack .../08-libgssapi-krb5-2_1.21.3-5_arm64.deb ...
Unpacking libgssapi-krb5-2:arm64 (1.21.3-5) ...
Selecting previously unselected package libunistring5:arm64.
Preparing to unpack .../09-libunistring5_1.3-2_arm64.deb ...
Unpacking libunistring5:arm64 (1.3-2) ...
Selecting previously unselected package libidn2-0:arm64.
Preparing to unpack .../10-libidn2-0_2.3.8-2_arm64.deb ...
Unpacking libidn2-0:arm64 (2.3.8-2) ...
Selecting previously unselected package libsasl2-modules-db:arm64.
Preparing to unpack .../11-libsasl2-modules-db_2.1.28+dfsg1-9_arm64.deb ...
Unpacking libsasl2-modules-db:arm64 (2.1.28+dfsg1-9) ...
Selecting previously unselected package libsasl2-2:arm64.
Preparing to unpack .../12-libsasl2-2_2.1.28+dfsg1-9_arm64.deb ...
Unpacking libsasl2-2:arm64 (2.1.28+dfsg1-9) ...
Selecting previously unselected package libldap2:arm64.
Preparing to unpack .../13-libldap2_2.6.10+dfsg-1_arm64.deb ...
Unpacking libldap2:arm64 (2.6.10+dfsg-1) ...
Selecting previously unselected package libnghttp2-14:arm64.
Preparing to unpack .../14-libnghttp2-14_1.64.0-1.1_arm64.deb ...
Unpacking libnghttp2-14:arm64 (1.64.0-1.1) ...
Selecting previously unselected package libnghttp3-9:arm64.
Preparing to unpack .../15-libnghttp3-9_1.8.0-1_arm64.deb ...
Unpacking libnghttp3-9:arm64 (1.8.0-1) ...
Selecting previously unselected package libpsl5t64:arm64.
Preparing to unpack .../16-libpsl5t64_0.21.2-1.1+b1_arm64.deb ...
Unpacking libpsl5t64:arm64 (0.21.2-1.1+b1) ...
Selecting previously unselected package libp11-kit0:arm64.
Preparing to unpack .../17-libp11-kit0_0.25.5-3_arm64.deb ...
Unpacking libp11-kit0:arm64 (0.25.5-3) ...
Selecting previously unselected package libtasn1-6:arm64.
Preparing to unpack .../18-libtasn1-6_4.20.0-2_arm64.deb ...
Unpacking libtasn1-6:arm64 (4.20.0-2) ...
Selecting previously unselected package libgnutls30t64:arm64.
Preparing to unpack .../19-libgnutls30t64_3.8.9-3_arm64.deb ...
Unpacking libgnutls30t64:arm64 (3.8.9-3) ...
Selecting previously unselected package librtmp1:arm64.
Preparing to unpack .../20-librtmp1_2.4+20151223.gitfa8646d.1-2+b5_arm64.deb ...
Unpacking librtmp1:arm64 (2.4+20151223.gitfa8646d.1-2+b5) ...
Selecting previously unselected package libssh2-1t64:arm64.
Preparing to unpack .../21-libssh2-1t64_1.11.1-1_arm64.deb ...
Unpacking libssh2-1t64:arm64 (1.11.1-1) ...
Selecting previously unselected package libcurl4t64:arm64.
Preparing to unpack .../22-libcurl4t64_8.14.1-2_arm64.deb ...
Unpacking libcurl4t64:arm64 (8.14.1-2) ...
Selecting previously unselected package curl.
Preparing to unpack .../23-curl_8.14.1-2_arm64.deb ...
Unpacking curl (8.14.1-2) ...
Selecting previously unselected package libldap-common.
Preparing to unpack .../24-libldap-common_2.6.10+dfsg-1_all.deb ...
Unpacking libldap-common (2.6.10+dfsg-1) ...
Selecting previously unselected package libsasl2-modules:arm64.
Preparing to unpack .../25-libsasl2-modules_2.1.28+dfsg1-9_arm64.deb ...
Unpacking libsasl2-modules:arm64 (2.1.28+dfsg1-9) ...
Selecting previously unselected package publicsuffix.
Preparing to unpack .../26-publicsuffix_20250328.1952-0.1_all.deb ...
Unpacking publicsuffix (20250328.1952-0.1) ...
Setting up libkeyutils1:arm64 (1.6.3-6) ...
Setting up libbrotli1:arm64 (1.1.0-2+b7) ...
Setting up libsasl2-modules:arm64 (2.1.28+dfsg1-9) ...
Setting up libnghttp2-14:arm64 (1.64.0-1.1) ...
Setting up krb5-locales (1.21.3-5) ...
Setting up libcom-err2:arm64 (1.47.2-3+b3) ...
Setting up libldap-common (2.6.10+dfsg-1) ...
Setting up libkrb5support0:arm64 (1.21.3-5) ...
Setting up libsasl2-modules-db:arm64 (2.1.28+dfsg1-9) ...
Setting up bash-completion (1:2.16.0-7) ...
Setting up libp11-kit0:arm64 (0.25.5-3) ...
Setting up libunistring5:arm64 (1.3-2) ...
Setting up libk5crypto3:arm64 (1.21.3-5) ...
Setting up libsasl2-2:arm64 (2.1.28+dfsg1-9) ...
Setting up libnghttp3-9:arm64 (1.8.0-1) ...
Setting up libtasn1-6:arm64 (4.20.0-2) ...
Setting up libkrb5-3:arm64 (1.21.3-5) ...
Setting up libssh2-1t64:arm64 (1.11.1-1) ...
Setting up publicsuffix (20250328.1952-0.1) ...
Setting up libldap2:arm64 (2.6.10+dfsg-1) ...
Setting up libidn2-0:arm64 (2.3.8-2) ...
Setting up libgssapi-krb5-2:arm64 (1.21.3-5) ...
Setting up libgnutls30t64:arm64 (3.8.9-3) ...
Setting up libpsl5t64:arm64 (0.21.2-1.1+b1) ...
Setting up librtmp1:arm64 (2.4+20151223.gitfa8646d.1-2+b5) ...
Setting up libcurl4t64:arm64 (8.14.1-2) ...
Setting up curl (8.14.1-2) ...
Processing triggers for libc-bin (2.41-12) ...
downloading uv 0.7.13 aarch64-unknown-linux-gnu
no checksums to verify
installing to /root/.local/bin
  uv
  uvx
everything's installed!

To add $HOME/.local/bin to your PATH, either restart your shell or run:

    source $HOME/.local/bin/env (sh, bash, zsh)
    source $HOME/.local/bin/env.fish (fish)
Initialized project `app`
Using CPython 3.11.13 interpreter at: /usr/local/bin/python3.11
Creating virtual environment at: .venv
Resolved 7 packages in 158ms
Prepared 5 packages in 182ms
Installed 5 packages in 14ms
 + iniconfig==2.1.0
 + packaging==25.0
 + pluggy==1.6.0
 + pygments==2.19.2
 + pytest==8.4.1
===================================================================== test session starts ======================================================================
platform linux -- Python 3.11.13, pytest-8.4.1, pluggy-1.6.0
rootdir: /tests
collected 6 items

../tests/test_outputs.py FFFFF.                                                                                                                          [100%]

=========================================================================== FAILURES ===========================================================================
_______________________________________________________________ test_consumer_fifo_and_awk_only ________________________________________________________________

    def test_consumer_fifo_and_awk_only():
        """Ensure correct usage of FIFO + awk only (no file reads or system())."""
        run_sh = Path("run.sh").read_text()
>       assert "cat pipe/events.fifo | awk -f consumer.awk" in run_sh
E       assert 'cat pipe/events.fifo | awk -f consumer.awk' in '#!/bin/bash\n\n# Supervisor script for the pipeline\nLOCKFILE="run.lock"\nFIFO="pipe/events.fifo
"\n\n# Cleanup functi...t_ms,\n  "consumer_end_ms": $consumer_end_ms,\n  "producer_end_ms": $producer_end_ms\n}\nTIMELINE_END\n\necho "DONE"\n'

/tests/test_outputs.py:18: AssertionError
____________________________________________________________ test_runtime_volume_rotations_timeline ____________________________________________________________

    def test_runtime_volume_rotations_timeline():
        """Check minimum volume, rotation count, and valid timeline."""
        sm = json.loads(_read(SUMMARY))
        tm = json.loads(_read(TIMELINE))

>       assert sm.get("producer_lines_total", 0) >= 1100, "need >=1100 lines"
E       AssertionError: need >=1100 lines
E       assert 403 >= 1100
E        +  where 403 = <built-in method get of dict object at 0xffffaaad48c0>('producer_lines_total', 0)
E        +    where <built-in method get of dict object at 0xffffaaad48c0> = {'alerts': 1, 'parallel': True, 'producer_lines_total': 403, 'rotations_min': 0}.ge
t

/tests/test_outputs.py:27: AssertionError
_____________________________________________________________ test_alerts_truthy_diverse_antispam ______________________________________________________________

    def test_alerts_truthy_diverse_antispam():
        """Check alert truthiness, Unicode users, spam filtering."""
        lines = [line for line in _read(ALERTS).splitlines() if line.startswith("ALERT ")]
        users = set()
        for line in lines:
            tokens = line.split()
            assert len(tokens) >= 6, "alert format error"
            users.add(tokens[1])

>       assert len(users) >= 2, "need ≥2 distinct users"
E       AssertionError: need ≥2 distinct users
E       assert 1 >= 2
E        +  where 1 = len({'MariaGarcia'})

/tests/test_outputs.py:43: AssertionError
_____________________________________________________________ test_run_sh_parallel_and_idempotent ______________________________________________________________

    def test_run_sh_parallel_and_idempotent():
        """Check backgrounding and lock mechanism."""
        rs = _read(Path("run.sh"))
        assert "flock" in rs
>       assert "producer.py" in rs and "&" in rs, "producer must run in background"
E       AssertionError: producer must run in background
E       assert ('producer.py' in '#!/bin/bash\n\n# Supervisor script for the pipeline\nLOCKFILE="run.lock"\nFIFO="pipe/events.fifo"\n\n# Cleanup functi...t_ms,\
n  "consumer_end_ms": $consumer_end_ms,\n  "producer_end_ms": $producer_end_ms\n}\nTIMELINE_END\n\necho "DONE"\n')

/tests/test_outputs.py:68: AssertionError
___________________________________________________________________ test_rotations_and_sizes ___________________________________________________________________

    def test_rotations_and_sizes():
        """Check presence and non-trivial size of all rotated logs."""
        log_files = [LOGS / "events.log", LOGS / "events.log.1", LOGS / "events.log.2", LOGS / "events.log.3"]
        for p in log_files:
>           assert p.exists(), f"{p.name} missing"
E           AssertionError: events.log.1 missing
E           assert False
E            +  where False = exists()
E            +    where exists = PosixPath('logs/events.log.1').exists

/tests/test_outputs.py:75: AssertionError
============================================================================ PASSES ============================================================================
=================================================================== short test summary info ====================================================================
PASSED ../tests/test_outputs.py::test_summary_timeline_and_parallelism
FAILED ../tests/test_outputs.py::test_consumer_fifo_and_awk_only - assert 'cat pipe/events.fifo | awk -f consumer.awk' in '#!/bin/bash\n\n# Supervisor script fo
r the pipeline\nLOCKFILE="run.lock"\nFIFO="pipe/events.fifo"\n...
FAILED ../tests/test_outputs.py::test_runtime_volume_rotations_timeline - AssertionError: need >=1100 lines
FAILED ../tests/test_outputs.py::test_alerts_truthy_diverse_antispam - AssertionError: need ≥2 distinct users
FAILED ../tests/test_outputs.py::test_run_sh_parallel_and_idempotent - AssertionError: producer must run in background
FAILED ../tests/test_outputs.py::test_rotations_and_sizes - AssertionError: events.log.1 missing
================================================================= 5 failed, 1 passed in 0.04s ==================================================================
root@38ff7a4514c0:/app#
